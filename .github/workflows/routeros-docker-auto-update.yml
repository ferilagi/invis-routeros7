name: RouterOS Docker Auto Update

on:
  schedule:
    - cron: "0 6 * * *" # Setiap jam 6 pagi UTC
  workflow_dispatch: # Manual trigger
  push:
    branches: [main]

jobs:
  update-build-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # GITHUB_TOKEN otomatis tersedia, tidak perlu setup
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Run Update Script
        id: update
        run: |
          chmod +x git-action-cron.sh
          ./git-action-cron.sh
        continue-on-error: true # Lanjut meski tidak ada update

      - name: Set up QEMU for multi-arch
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      #- name: Login to GitHub Container Registry
      #  uses: docker/login-action@v3
      #  with:
      #    registry: ghcr.io
      #    username: ${{ github.actor }}
      #    password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from Dockerfile
        id: version
        run: |
          VERSION=$(grep 'ARG ROUTEROS_VERSION=' Dockerfile | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building RouterOS $VERSION"

      - name: Build and push multi-arch to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/ros7:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/ros7:latest
          # Untuk GitHub Container Registry (dikomen dulu):
          # ghcr.io/${{ github.repository }}/ros7:${{ steps.version.outputs.version }}
          # ghcr.io/${{ github.repository }}/ros7:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ROUTEROS_VERSION=${{ steps.version.outputs.version }}
            TARGETPLATFORM=${{ 'TARGETPLATFORM' }}

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: RouterOS ${{ steps.version.outputs.version }}
          body: |
            # RouterOS ${{ steps.version.outputs.version }}

            Automated build of Mikrotik RouterOS ${{ steps.version.outputs.version }}

            ## üê≥ Docker Image

            ```bash
            # Pull latest version
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/ros7:${{ steps.version.outputs.version }}

            # Or always get the latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/ros7:latest
            ```

            ## üì¶ Multi-arch Support
            - ‚úÖ **linux/amd64** (x86_64, Intel/AMD)
            - ‚úÖ **linux/arm64** (ARM64, Apple Silicon, Raspberry Pi 4)

            ## üöÄ Quick Start
            ```bash
            docker run -d \
              --name routeros \
              --privileged \
              --cap-add=NET_ADMIN \
              --device /dev/net/tun \
              -p 8291:8291 \
              -p 8728:8728 \
              -p 8729:8729 \
              ${{ secrets.DOCKERHUB_USERNAME }}/ros7:latest
            ```

            ## üìÑ Source Code
            - [Dockerfile](https://github.com/${{ github.repository }}/blob/main/Dockerfile)
            - [GitHub Repository](https://github.com/${{ github.repository }})
          draft: false
          prerelease: false
          files: |
            Dockerfile
            README.md
